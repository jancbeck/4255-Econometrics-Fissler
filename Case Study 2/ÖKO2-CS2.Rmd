---
title: "Case Study 2 - Group 1"
author:
- Annika Janson h11829506
- Jan Beck h11814291
- Franz Uchatzi h1451890
date: "19.3.2021"
output:
  pdf_document: default
  html_document:
    df.print: paged
  word_document: default
header-includes:
- \usepackage{dcolumn}
- \renewcommand{\and}{\\}
---


```{r setup, include=FALSE}
library(car)
library(forecast)
library(apsrtable)
library(lmtest)


knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
gdp <- read.csv("USGDP.csv")
N <- nrow(gdp)
```

# 1.2 Tasks

### 1.2.1

```{r, echo=FALSE}
ts_gdp <- window( ts(gdp$NA000334Q, frequency = 4, start = c(2010, 1)), start=c(2010, 1), end=c(2019, 4) ) # get only subset till Q4 2019
md1 <- tslm(ts_gdp ~ trend + season)
md1_sum <- summary(md1)
md1_bic <- BIC(md1)
md1_aic <- AIC(md1)
md1_coef <- as.vector(coefficients(md1))
```

```{r md1,  results='asis', echo=FALSE }
apsrtable::apsrtable(md1, Sweave = TRUE, col.hspace="1em", caption="Figure 1: Model 1 summary")
```

The adjusted R^2^ is __`r md1_sum$adj.r.squared `__, the BIC is __`r md1_bic `__ and the AIC is __`r md1_aic `__.

### 1.2.2

### 1.2.3

The precise values of the 5 estimators can also be seen in the Model 1 summary table under __1.2.1__. The intercept value of __`r format(md1_coef[1]) `__ means that this is the expected value of US GDP at t=0 or Q1 2010. On average, US GDP grows by __`r format(md1_coef[2]) `__ every quarter. In a second quarter of a year, US GDP grows additionally by __`r format(md1_coef[3]) `__, __`r format(md1_coef[4]) `__ in a third and __`r format(md1_coef[5]) `__ in the last quarter of a year. The implies that the first quarter is the weakest quarter, because all seasonal variables are positive and the trend and intercept parameters act as a baseline for the first quarter.

### 1.2.4

```{r, echo=FALSE}
plot(ts_gdp, main = "Fig. 1: US GDP and Model 1 fitted values", ylab = "in millions of Dollars", xlab = "Year")
lines(md1$fitted.values, col="red")
legend("bottomright", legend=c("US GDP", "Fitted values"), col=c("black", "red"), lty=1:1)

plot(md1$residuals, main = "Fig. 2: Model 1 residuals", ylab = "residuals", xlab = "Year", col="red")
abline(0,0, col="blue")

```

Assumption A1, $\mathbb{E}\left(u_{t}\right)=0$, seems violated, since the residuals lie mostly above 0 for values before 2012 and after 2018 and below 0 for the values in between. This suggests there is a systematic error in our model.  
Assumption A2 seems violated because the values tend to fluctuate stronger in the time frame of 2012 to 2014 than they to from 2014 till 2017.

### 1.2.5

```{r, echo=FALSE}
Acf(md1$residuals)
Pacf(md1$residuals)

```

### 1.2.6

```{r, echo=FALSE}
order_checker <- function(Y, max.order = 3, xreg = NULL, I = 0, include.drift = FALSE){

  params <- list()

  for (j in c("ar", "ma")){
    for (i in 1:max.order){
     params[[paste0(j, i)]] <- c(0, NA)
    }
  }

  if (!is.null(xreg)){
    for (j in colnames(xreg)){
      params[[j]] <- NA
    }
  }

  params$intercept <- NA

  combinations <- expand.grid(params)
  res <- data.frame(BIC = rep(NA, nrow(combinations)), AIC = NA)


  pb <- txtProgressBar(1, nrow(combinations), style = 3)
  for (i in 1:nrow(combinations)){
    curr_mod <- try(Arima(Y, order = c(max.order, I, max.order), fixed = c(combinations[i, ]),
                      xreg = xreg, method = "ML", include.drift = include.drift), silent = TRUE)

    if ("try-error" %in% attr(curr_mod, "class")){
      res$BIC[i] <- NA
      res$AIC[i] <- NA
    } else {
      res$BIC[i] <- BIC(curr_mod)
      res$AIC[i] <- AIC(curr_mod)
    }
    setTxtProgressBar(pb, i)
  }

  res <- merge(res, combinations, by = 0)
  res$Row.names <- NULL
  return(res)
}

trend <- seq(from=1, to=length(ts_gdp), by=1)
season2 <- rep(c(0,1,0,0), 10)
season3 <- rep(c(0,0,1,0), 10)
season4 <- rep(c(0,1,0,1), 10)
m <- cbind(trend, season2, season3, season4)

res <- order_checker(ts_gdp, 4, m)
#res[which.min(res$BIC), ]
#res[which.min(res$AIC), ]
res_aic <- res[which.min(res$AIC),][2]
res_bic <- res[which.min(res$BIC),][1]
```

The ARMA model with the order of (1,4) results in the lowest value of BIC and AIC for all possible ARMA models up to order (4,4). The BIC is __`r format(res_bic) `__ and the AIC is __`r format(res_aic) `__.

### 1.2.7

### 1.2.8

```{r, echo=FALSE}
md2 <- Arima(ts_gdp, order=c(4,0,4), xreg=m, fixed=res[which.min(res$AIC),-c(1,2)], method="ML")

```

### 1.2.9

### 1.2.10

### 1.2.11

### 1.2.12

a)

b) Bonus:

```{r, echo=FALSE}
X <- cbind(seq(from=41, to=49, by=1), rep(c(0,1,0,0), 2), rep(c(0,0,1,0), 2), rep(c(0,1,0,1), 2))

plot(forecast(md2, x=X, h=8))


```